<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tótem Informativo - Buses Panguipulli</title>

    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-blue-700 text-white p-4 text-center text-xl font-bold shadow-md">
        Horarios de buses – Terminal Panguipulli
    </header>

    <!-- BÚSQUEDA -->
    <div class="p-4">
        <input id="busqueda" type="search"
               placeholder="Buscar origen, destino, empresa, etc..."
               class="w-full p-3 rounded-lg border border-gray-300 shadow-sm outline-none">
    </div>

    <!-- LISTA DE HORARIOS -->
    <main class="px-4 pb-16">
        <table class="w-full rounded-lg overflow-hidden shadow bg-white text-sm">
            <thead class="bg-blue-600 text-white">
                <tr>
                    <th class="p-2">Empresa</th>
                    <th class="p-2">Origen</th>
                    <th class="p-2">Destino</th>
                    <th class="p-2">Salida</th>
                    <th class="p-2">Andén</th>
                </tr>
            </thead>
            <tbody id="lista-horarios"></tbody>
        </table>
    </main>

    <!-- PWA -->
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js");
        }
    </script>

    <!-- CARGA DE HORARIOS DESDE app.py -->
    <script>
        async function cargarHorarios() {
            const res = await fetch("/api/horarios");
            const json = await res.json();

            const lista = document.getElementById("lista-horarios");
            lista.innerHTML = "";

            json.data.forEach(h => {
                lista.innerHTML += `
                <tr data-horario
                    data-origen="${h.origen}"
                    data-destino="${h.destino}"
                    data-empresa="${h.empresa}"
                    data-salida="${h.salida}"
                    class="border-b hover:bg-gray-100">
                    <td class="p-2">${h.empresa}</td>
                    <td class="p-2">${h.origen}</td>
                    <td class="p-2">${h.destino}</td>
                    <td class="p-2">${h.salida}</td>
                    <td class="p-2">${h.anden}</td>
                </tr>`;
            });
        }
        cargarHorarios();
    </script>

    <!-- ✅ BÚSQUEDA RÁPIDA (NO ALTERA NADA MÁS) -->
    <script>
    (function () {

      const stripAccents = s =>
        (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      const norm = s =>
        stripAccents(String(s || "")).toLowerCase().trim().replace(/\s+/g, " ");

      const tokenize = q => {
        q = norm(q);
        const phrases = Array.from(q.matchAll(/"([^"]+)"/g)).map(m => norm(m[1]));
        const rest = q.replace(/"[^"]+"/g, " ").trim();
        const words = rest ? rest.split(/\s+/).map(norm) : [];
        return { phrases, words };
      };

      const matchText = (text, q) => {
        const t = norm(text);
        const { phrases, words } = tokenize(q);
        for (const ph of phrases) if (!t.includes(ph)) return false;
        for (const w of words) if (!t.includes(w)) return false;
        return true;
      };

      function buildText(el) {
        let txt = el.innerText || el.textContent || "";
        for (const a of ["data-origen","data-destino","data-empresa","data-salida","data-anden"])
          if (el.hasAttribute && el.hasAttribute(a)) txt += " " + el.getAttribute(a);
        return txt;
      }

      function quickSearch() {
        const input = document.getElementById("busqueda");
        if (!input) return;

        const rows = [...document.querySelectorAll("#lista-horarios [data-horario]")];
        const index = rows.map(el => ({ el, text: buildText(el) }));

        input.addEventListener("input", () => {
          const q = input.value;
          if (!q) return index.forEach(i => i.el.style.display = "");
          index.forEach(i =>
            i.el.style.display = matchText(i.text, q) ? "" : "none"
          );
        });
      }

      window.addEventListener("DOMContentLoaded", quickSearch);
    })();
    </script>

</body>
</html>
