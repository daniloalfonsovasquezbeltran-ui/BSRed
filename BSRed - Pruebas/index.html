<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tótem Informativo - Buses Panguipulli</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .status-ontime { background-color: #10B981; color: white; }
        .status-delayed { background-color: #F59E0B; color: white; }
        .status-next { background-color: #3B82F6; color: white; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tab styles */
        .tab-btn {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: #60A5FA; /* light blue */
            border-bottom-color: #60A5FA;
        }
    </style>
</head>

<body class="text-white">

    <div class="max-w-md mx-auto min-h-screen bg-gray-900 shadow-lg flex flex-col">

        <!-- Header -->
        <header class="p-4 bg-gray-800 border-b border-gray-700 shadow-md sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <img src="logo.jpg" alt="Logo de Autobús" class="h-8 w-8 rounded-full">
                <div>
                    <h1 class="text-xl font-bold text-white">Horarios de Buses</h1>
                    <p class="text-xs text-gray-400">Terminal Panguipulli</p>
                </div>
            </div>
            <div class="mt-4">
                 <input type="text" id="searchInput" placeholder="Buscar por destino, origen o empresa..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </header>

        <!-- Tabs Navigation -->
        <nav class="bg-gray-800 flex justify-around">
            <button id="tab-salidas" class="tab-btn w-full py-3 font-semibold text-gray-300 active">Salidas</button>
            <button id="tab-llegadas" class="tab-btn w-full py-3 font-semibold text-gray-300">Llegadas</button>
        </nav>

        <!-- Main Content: Schedule List -->
        <main id="schedule-container" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Schedule cards will be injected here by JavaScript -->
        </main>

        <!-- Footer -->
        <footer class="p-2 text-center text-xs text-gray-500 border-t border-gray-700">
            <p>&copy; 2025 - Proyecto Liceo Bicentenario Pullinque</p>
        </footer>
        
        <!-- Notification Message -->
        <div id="notification-toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 translate-y-16">
            ¡Notificación programada!
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scheduleContainer = document.getElementById('schedule-container');
            const searchInput = document.getElementById('searchInput');
            const notificationToast = document.getElementById('notification-toast');
            const tabSalidas = document.getElementById('tab-salidas');
            const tabLlegadas = document.getElementById('tab-llegadas');
            
            let allSchedules = [];
            let activeTab = 'salida'; // 'salida' or 'llegada'

            const API_URL = 'http://127.0.0.1:5000/api/horarios';

            function showToast(message) {
                notificationToast.textContent = message;
                notificationToast.classList.remove('hidden', 'translate-y-16');
                setTimeout(() => {
                    notificationToast.classList.add('translate-y-16');
                     setTimeout(() => notificationToast.classList.add('hidden'), 300);
                }, 3000);
            }

            function getStatusClass(status) {
                switch (status.toLowerCase()) {
                    case 'a tiempo': return 'status-ontime';
                    case 'retrasado': return 'status-delayed';
                    case 'próximo': return 'status-next';
                    default: return 'bg-gray-500 text-white';
                }
            }
            
            // Function to render the currently filtered schedules
            function renderSchedules(schedulesToRender) {
                scheduleContainer.innerHTML = ''; // Clear previous content
                if (schedulesToRender.length === 0) {
                     scheduleContainer.innerHTML = `<div class="text-center text-gray-400 mt-8">No se encontraron buses.</div>`;
                     return;
                }

                schedulesToRender.forEach(bus => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700 fade-in';
                    
                    const locationTitle = activeTab === 'salida' ? `Destino: ${bus.destino}` : `Origen: ${bus.origen}`;
                    const locationSubtitle = activeTab === 'salida' ? `Desde: ${bus.origen}` : `Hacia: ${bus.destino}`;

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-lg font-bold text-white">${locationTitle}</p>
                                <p class="text-sm text-gray-400">${bus.empresa}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${getStatusClass(bus.estado)}">${bus.estado}</span>
                                <p class="text-sm text-gray-300 mt-1">Andén ${bus.anden}</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-between items-center text-sm text-gray-300">
                           <div>
                                <p><strong>Salida:</strong> <span class="font-mono">${bus.salida}</span></p>
                                <p><strong>Llegada:</strong> <span class="font-mono">${bus.llegada}</span></p>
                           </div>
                           <button class="notify-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-xs transition-colors" data-id="${bus.id}" data-destino="${bus.destino}" data-origen="${bus.origen}" data-salida="${bus.salida}" data-anden="${bus.anden}">
                                Notificar
                           </button>
                        </div>
                    `;
                    scheduleContainer.appendChild(card);
                });
            }

            // Central function to update the view based on active tab and search term
            function updateView() {
                const searchTerm = searchInput.value.toLowerCase();
                
                const filteredByType = allSchedules.filter(bus => bus.tipo === activeTab);
                
                const filteredBySearch = filteredByType.filter(bus => 
                    bus.destino.toLowerCase().includes(searchTerm) ||
                    bus.origen.toLowerCase().includes(searchTerm) ||
                    bus.empresa.toLowerCase().includes(searchTerm)
                );
                
                renderSchedules(filteredBySearch);
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error('Network response was not ok');
                    allSchedules = await response.json();
                    updateView(); // Initial render
                } catch (error) {
                    console.error('Error fetching data:', error);
                    scheduleContainer.innerHTML = `<div class="text-center text-red-400 mt-8 p-4 bg-red-900 bg-opacity-50 rounded-lg">
                        <p class="font-bold">Error de Conexión</p>
                        <p class="text-sm">No se pudo conectar al servidor. Asegúrate de que el programa 'app.py' se esté ejecutando.</p>
                    </div>`;
                }
            }

            // Event Listeners
            searchInput.addEventListener('input', updateView);

            tabSalidas.addEventListener('click', () => {
                if (activeTab === 'salida') return;
                activeTab = 'salida';
                tabSalidas.classList.add('active');
                tabLlegadas.classList.remove('active');
                updateView();
            });

            tabLlegadas.addEventListener('click', () => {
                if (activeTab === 'llegada') return;
                activeTab = 'llegada';
                tabLlegadas.classList.add('active');
                tabSalidas.classList.remove('active');
                updateView();
            });

            scheduleContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('notify-btn')) {
                    const button = e.target;
                    const { destino, origen, salida, anden } = button.dataset;
                    const notificationDest = activeTab === 'salida' ? destino : origen;
                    const notificationMsg = activeTab === 'salida' ? 
                        `Tu bus a ${destino} sale en 30 segundos del andén ${anden}.` :
                        `El bus desde ${origen} llega en 30 segundos al andén ${anden}.`;

                    scheduleNotification(notificationDest, salida, notificationMsg);
                }
            });

            function scheduleNotification(destination, time, messageBody) {
                if (!('Notification' in window)) {
                    alert('Este navegador no soporta notificaciones de escritorio.');
                    return;
                }

                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        const [hours, minutes] = time.split(':').map(Number);
                        const now = new Date();
                        const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);

                        if (eventTime < now) {
                           showToast("La hora de este evento ya pasó.");
                           return;
                        }

                        // Notify 30 seconds before
                        const timeout = eventTime.getTime() - now.getTime() - 30000;

                        if (timeout > 0) {
                            setTimeout(() => {
                                new Notification('¡Recordatorio!', {
                                    body: messageBody,
                                    icon: 'https://placehold.co/64x64/3b82f6/ffffff?text=BUS'
                                });
                            }, timeout);
                            showToast(`Aviso para el bus (${destination}) programado.`);
                        } else {
                            showToast("Falta muy poco para este evento.");
                        }

                    } else {
                         showToast("Permiso de notificación denegado.");
                    }
                });
            }

            // Initial data fetch
            fetchData();
        });
    </script>
</body>
</html>


